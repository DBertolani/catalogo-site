<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo Completo - DEAB</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

<style>
    /* --- ESTILOS GERAIS (PADRÃO DEAB) --- */
    * { box-sizing: border-box; }
    body { font-family: 'Open Sans', sans-serif; margin: 0; padding: 0; padding-top: 70px; background-color: #f8f9fa; color: #333; overflow-x: hidden; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px 15px; }

    /* NAVBAR */
    .navbar { position: fixed; top: 0; left: 0; width: 100%; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; padding: 10px 20px; }
    .nav-container { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
    .logo { font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: 1.4rem; text-decoration: none; background: linear-gradient(45deg, #d32f2f, #ff5252); -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1;}
    .logo span { font-size: 0.7rem; color: #555; -webkit-text-fill-color: #555; display: block; letter-spacing: 1px; font-weight: 400;}
    .nav-links { display: flex; gap: 20px; align-items: center; }
    .nav-item { text-decoration: none; color: #555; font-weight: 600; font-size: 0.9rem; padding: 8px 12px; border-radius: 6px; transition: 0.2s; }
    .nav-item:hover, .nav-item.active { background-color: #f0f0f0; color: #d32f2f; }
    .hamburger { display: none; cursor: pointer; background: none; border: none; font-size: 24px; color: #333; }

    /* HEADER INTERNO */
    .header { text-align: center; margin-bottom: 35px; }
    .header h1 { color: #2c3e50; margin-bottom: 10px; font-family: 'Montserrat', sans-serif;}

    /* BARRA DE BUSCA */
    .search-and-filter-container { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
    .search-container { flex-grow: 1; display: flex; gap: 10px; }
    .search-container input[type="text"] { flex-grow: 1; padding: 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 16px; }
    .search-container button, #filterButton { padding: 12px 20px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
    .search-container button:hover { background-color: #0056b3; }

    /* GRID */
    .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 25px; justify-content: center; }
    
    /* CARD NOVO ESTILO */
    .product-card { background-color: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; text-align: center; display: flex; flex-direction: column; transition: transform 0.2s; border: 1px solid #eee; height: 100%; max-width: 400px; margin: 0 auto; width: 100%; }
    .product-card:hover { transform: translateY(-5px); }

    .product-card-image-container { position: relative; width: 100%; padding-top: 100%; background-color: #fff; border-bottom: 1px solid #f0f0f0;}
    .product-card-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; padding: 15px; }

    .product-card-content { padding: 15px; display: flex; flex-direction: column; flex-grow: 1; justify-content: space-between; }
    .product-card-title { color: #333; font-size: 1rem; margin: 0 0 10px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; min-height: 4.2em; }
    .product-card-store span { color: #6f42c1; font-weight: bold; text-transform: uppercase; font-size: 0.8em;}
    .product-card-price { color: #28a745; font-size: 1.4em; font-weight: 800; margin: 10px 0; }

    .btn-details { background-color: #6c757d; color: white; padding: 10px; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 0.9em; display:block; margin-bottom:5px; cursor: pointer; border: none; width: 100%;}
    .btn-buy { background-color: #28a745; color: white; padding: 12px; border-radius: 6px; text-decoration: none; font-weight: bold; text-transform: uppercase; font-size: 0.9em; display: block; }

    /* MODAL */
    .modal { display: none; position: fixed; z-index: 1100; inset: 0; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; padding: 15px; backdrop-filter: blur(3px); }
    .modal-content { background-color: #fff; border-radius: 12px; width: 100%; max-width: 900px; max-height: 90vh; display: flex; flex-direction: row; overflow: hidden; position: relative; }
    .modal-image-col { width: 45%; display: flex; align-items: center; justify-content: center; padding: 20px; background: #fff; border-right: 1px solid #eee; }
    .modal-image-col img { max-width: 100%; max-height: 50vh; object-fit: contain; }
    .modal-details-col { width: 55%; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }
    .close-button { position: absolute; top: 10px; right: 15px; font-size: 32px; cursor: pointer; border:none; background:none; z-index: 1200;}
    #modalTitle { font-size: 1.6em; margin-top: 0; line-height: 1.3; }
    #modalPrice { font-size: 2.2em; font-weight: 800; color: #28a745; margin: 15px 0; }
    .modal-description-box { background-color: #f9f9f9; padding: 15px; border-radius: 8px; margin: 15px 0; color: #555; font-size: 0.95em; text-align: left; }
    .modal-buttons-container { display: flex; gap: 15px; margin-top: auto; }
    #modalBuyButton, #shareProductButton { flex: 1; padding: 15px; border-radius: 6px; font-weight: bold; text-align: center; cursor: pointer; color: white; border:none;}
    #shareProductButton { background-color: #6c757d; }
    #modalBuyButton { background-color: #28a745; text-decoration: none; display: flex; align-items: center; justify-content: center;}

    /* WHATSAPP */
    .whatsapp-float { position: fixed; bottom: 20px; right: 20px; background-color: #25d366; color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 2px 2px 10px rgba(0,0,0,0.3); z-index: 2000; transition: transform 0.2s;}
    .whatsapp-float:hover { transform: scale(1.1); }

    /* Loader e Filtros */
    #activeFilters { margin-bottom: 20px; padding: 10px 15px; background-color: #e9ecef; border-radius: 6px; display: none; font-size: 0.9em; }
    #loader-container { text-align: center; margin-top: 50px; display: none; }
    .loader { border: 5px solid #f3f3f3; border-top: 5px solid #007bff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* RESPONSIVIDADE */
    @media (max-width: 768px) {
        .nav-links { display: none; flex-direction: column; width: 100%; position: absolute; top: 60px; left: 0; background: white; padding: 10px 0; box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
        .nav-links.active { display: flex; }
        .hamburger { display: block; }
        
        .product-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .product-card-title { font-size: 0.9em; min-height: 3.6em; }
        .product-card-price { font-size: 1.1em; }
        .btn-buy, .btn-details { padding: 8px; font-size: 0.8rem; }
        
        .modal-content { flex-direction: column; width: 95%; margin: 0 auto; }
        .modal-image-col { width: 100%; height: 250px; border-right: none; border-bottom: 1px solid #eee; padding: 10px; }
        .modal-details-col { width: 100%; padding: 20px; }
        .modal-buttons-container { flex-direction: column; }
    }
    
    /* Ocultar scroll quando modal aberto */
    .no-scroll { overflow: hidden; }
</style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="logo">DEAB<br><span>OFERTAS INCRÍVEIS</span></a>
            <button class="hamburger" onclick="toggleMenu()">☰</button>
            <div class="nav-links" id="navLinks">
                <a href="/" class="nav-item">Início</a>
                <a href="#" class="nav-item active">Catálogo</a>
                <a href="/Ofertas" class="nav-item">Ofertas Relâmpago</a>
                <a href="/Cupons" class="nav-item">Cupons</a>
            </div>
        </div>
    </nav>

    <a href="https://wa.me/5527996962395?text=Olá! Preciso de ajuda com um produto do catálogo." class="whatsapp-float" target="_blank">
        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" width="35" height="35" alt="Zap">
    </a>

    <div class="container">
        <div class="header">
            <h1>Catálogo Completo</h1>
        </div>

        <div class="search-and-filter-container">
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Busque por produto, marca ou loja...">
                <button id="searchButton">Buscar</button>
            </div>
            <button id="filterButton">Filtros</button>
        </div>

        <div id="activeFilters"><p>Filtros aplicados: <span id="filtersAppliedText"></span> <button id="clearFiltersButton">Limpar</button></p></div>
        
        <div id="loader-container"><div class="loader"></div><div class="loader-text">Carregando produtos...</div></div>
        
        <div id="productGrid" class="product-grid"></div>
        
        <div style="text-align: center; margin: 30px 0;">
            <button id="loadMoreBtn" class="btn-details" style="display:none; width: 200px; margin: 0 auto; background:#007bff; color:white;">Carregar Mais</button>
            <p id="noMoreProducts" style="display:none; color: #888;">Fim dos resultados.</p>
        </div>
    </div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <button class="close-button" onclick="closeProductModal()">&times;</button>
            <div class="modal-image-col"><img id="modalImage" src=""></div>
            <div class="modal-details-col">
                <h2 id="modalTitle"></h2>
                <div id="modalPrice"></div>
                <p><strong>Loja:</strong> <span id="modalStore"></span></p>
                <p><strong>Marca:</strong> <span id="modalBrand"></span></p>
                <p><strong>Categoria:</strong> <span id="modalCategory"></span></p>
                <div class="modal-description-box">
                     <strong>Detalhes:</strong><br>
                     <span id="modalDescription" style="white-space: pre-wrap;"></span>
                </div>
                <div class="modal-buttons-container">
                    <button id="shareProductButton">Compartilhar</button>
                    <a href="#" target="_blank" id="modalBuyButton">Ir para a Loja</a>
                </div>
            </div>
        </div>
    </div>

    <div id="filterModal" class="modal">
        <div class="modal-content" style="max-width:500px; flex-direction:column; height:auto; width:95%;">
             <div style="padding:20px; width:100%;">
                <button class="close-button" onclick="closeFilterModal()" style="position:absolute; top:10px; right:10px;">&times;</button>
                <h3 style="margin-top:0;">Filtrar</h3>
                <div id="filterOptions"></div>
                <button id="applyFiltersButton" style="background:#007bff; color:white; border:none; padding:12px; width:100%; margin-top:15px; cursor:pointer; border-radius:6px; font-weight:bold;">Aplicar</button>
             </div>
        </div>
    </div>

    <script>
        function toggleMenu() { document.getElementById('navLinks').classList.toggle('active'); }
        
        // --- LÓGICA ORIGINAL (MANTIDA E ADAPTADA AO NOVO DESIGN) ---
        
        let currentOffset = 0;
        const productsPerPage = 50;
        let currentQuery = new URLSearchParams(window.location.search).get('query') || '';
        let totalProductsFound = 0;
        const MAX_DESC_LENGTH = 180; 

        let currentProduct = null;
        let currentStoreFilter = '';
        let currentCategoryFilter = '';
        let currentBrandFilter = '';

        // Elementos
        const productGrid = document.getElementById('productGrid');
        const loaderContainer = document.getElementById('loader-container');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const noMoreProductsMsg = document.getElementById('noMoreProducts');
        const activeFiltersContainer = document.getElementById('activeFilters');
        const filtersAppliedText = document.getElementById('filtersAppliedText');
        const clearFiltersButton = document.getElementById('clearFiltersButton');
        
        // Modais
        const productModal = document.getElementById('productModal');
        const filterModal = document.getElementById('filterModal');
        const filterButton = document.getElementById('filterButton');
        const applyFiltersButton = document.getElementById('applyFiltersButton');

        // Funções de Apoio
        function formatMoney(value) {
            if (!value) return "R$ 0,00";
            let num = typeof value === 'string' ? parseFloat(value.replace('R$', '').replace(',', '.')) : value;
            if (isNaN(num)) return value;
            return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function showLoader() {
            loaderContainer.style.display = 'block';
            productGrid.style.display = 'none';
            loadMoreBtn.style.display = 'none';
            noMoreProductsMsg.style.display = 'none';
        }

        function hideLoader() {
            loaderContainer.style.display = 'none';
            productGrid.style.display = 'grid';
        }

        // --- CRIAÇÃO DO CARD COM NOVO DESIGN ---
        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card';
            const priceFormatted = formatMoney(product.preco);

            // Nota: O JS converte o objeto product para string segura para o onclick
            const productString = JSON.stringify(product).replace(/'/g, "&apos;");

            card.innerHTML = `
                <div class="product-card-image-container">
                    <img src="${product.imagem}" alt="${product.nome}" class="product-card-image" loading="lazy" onerror="this.src='https://via.placeholder.com/300x300?text=Sem+Imagem'">
                </div>
                <div class="product-card-content">
                    <div class="product-card-store">Vendido por <span>${product.lojaParceira || 'Parceiro'}</span></div>
                    <h3 class="product-card-title" title="${product.nome}">${product.nome}</h3>
                    <div class="product-card-price">${priceFormatted}</div>
                    
                    <div class="product-card-buttons">
                        <button class="btn-details" onclick='openProductModal(${productString})'>Mais Detalhes</button>
                        <a href="${product.linkAfiliado}" target="_blank" class="btn-buy">
                           Comprar Agora
                        </a>
                    </div>
                </div>
            `;
            return card;
        }

        // --- FETCH DOS PRODUTOS (MANTIDO) ---
        function loadProducts(append) {
            append = typeof append === 'undefined' ? true : append;
            showLoader();

            if (!append) currentOffset = 0;

            const url = `https://teste-api.deab.com.br/api/produtos?offset=${currentOffset}&limit=${productsPerPage}&query=${encodeURIComponent(currentQuery)}&store=${encodeURIComponent(currentStoreFilter)}&category=${encodeURIComponent(currentCategoryFilter)}&brand=${encodeURIComponent(currentBrandFilter)}`;

            fetch(url)
            .then(res => res.json())
            .then(response => {
                hideLoader();
                const products = response.products || [];
                totalProductsFound = response.total || 0;

                if (!append) productGrid.innerHTML = '';

                if (products.length === 0 && currentOffset === 0) {
                    productGrid.innerHTML = '<p class="no-products">Nenhum produto encontrado. Tente outra busca.</p>';
                    loadMoreBtn.style.display = 'none';
                } else {
                    products.forEach(product => {
                        productGrid.appendChild(createProductCard(product));
                    });
                    currentOffset += products.length;
                    
                    if (currentOffset < totalProductsFound) {
                        loadMoreBtn.style.display = 'block';
                    } else {
                        loadMoreBtn.style.display = 'none';
                        noMoreProductsMsg.style.display = 'block';
                    }
                }
                updateActiveFiltersDisplay();
            })
            .catch(error => {
                hideLoader();
                console.error("Erro:", error);
                productGrid.innerHTML = '<p class="no-products">Erro de conexão.</p>';
            });
        }

        // --- MODAL LOGIC ---
        function openProductModal(product) {
            if (typeof product === 'string') {
                try { product = JSON.parse(product); } catch(e){ return; }
            }
            currentProduct = product;

            document.getElementById('modalImage').src = product.imagem || '';
            document.getElementById('modalTitle').textContent = product.nome || '';
            document.getElementById('modalPrice').textContent = formatMoney(product.preco);
            document.getElementById('modalStore').textContent = product.lojaParceira || 'Parceiro';
            document.getElementById('modalBrand').textContent = product.marca || '-';
            document.getElementById('modalCategory').textContent = product.categoria || '-';
            document.getElementById('modalDescription').textContent = product.descricao || 'Sem descrição.';
            document.getElementById('modalBuyButton').href = product.linkAfiliado || '#';

            productModal.style.display = 'flex';
            document.body.classList.add('no-scroll');
        }

        function closeProductModal() {
            productModal.style.display = 'none';
            document.body.classList.remove('no-scroll');
        }

        // --- COMPARTILHAMENTO WHATSAPP (LINK P/ PÁGINA INTERNA) ---
        document.getElementById('shareProductButton').addEventListener('click', function() {
            if (!currentProduct) return;
            
            // Cria link para a página de detalhes (/p/ID)
            const productPageLink = `${window.location.origin}/p/${currentProduct.id}`;

            const msg = `Olha que oferta!\n\n*${currentProduct.nome}*\nPreço: ${formatMoney(currentProduct.preco)}\nLoja: ${currentProduct.lojaParceira}\n\nLink: ${productPageLink}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        });

        // --- FILTROS ---
        function updateActiveFiltersDisplay() {
            let filters = [];
            if (currentQuery) filters.push(`Pesquisa: "${currentQuery}"`);
            if (currentStoreFilter) filters.push(`Loja: "${currentStoreFilter}"`);
            if (currentCategoryFilter) filters.push(`Categoria: "${currentCategoryFilter}"`);
            if (currentBrandFilter) filters.push(`Marca: "${currentBrandFilter}"`);

            if (filters.length > 0) {
                filtersAppliedText.innerHTML = filters.map(f => `<strong>${f}</strong>`).join(' | ');
                activeFiltersContainer.style.display = 'block';
            } else {
                activeFiltersContainer.style.display = 'none';
                filtersAppliedText.textContent = '';
            }
        }

        async function loadGlobalFilters() {
            const filterApiUrl = "https://teste-api.deab.com.br/api/filtros";
            const container = document.getElementById('filterOptions');
            if (!container) return;

            try {
                const response = await fetch(filterApiUrl);
                const data = await response.json();
                if (!data.stores) return;

                // HTML do filtro (igual ao que você já tinha)
                container.innerHTML = `
                <div style="margin-bottom:15px"><label style="font-weight:bold;display:block;margin-bottom:5px;">Loja:</label><input list="storeDatalist" id="storeFilterInput" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;" placeholder="Todas" value="${currentStoreFilter}"><datalist id="storeDatalist"><option value="">Todas</option>${data.stores.map(s => `<option value="${s}">`).join('')}</datalist></div>
                <div style="margin-bottom:15px"><label style="font-weight:bold;display:block;margin-bottom:5px;">Categoria:</label><input list="categoryDatalist" id="categoryFilterInput" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;" placeholder="Todas" value="${currentCategoryFilter}"><datalist id="categoryDatalist"><option value="">Todas</option>${data.categories.map(c => `<option value="${c}">`).join('')}</datalist></div>
                <div style="margin-bottom:15px"><label style="font-weight:bold;display:block;margin-bottom:5px;">Marca:</label><input list="brandDatalist" id="brandFilterInput" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;" placeholder="Todas" value="${currentBrandFilter}"><datalist id="brandDatalist"><option value="">Todas</option>${data.brands.map(b => `<option value="${b}">`).join('')}</datalist></div>
                `;
            } catch (error) { console.error("Erro filtros:", error); }
        }

        // Listeners
        filterButton.addEventListener('click', () => { filterModal.style.display = "flex"; });
        function closeFilterModal() { filterModal.style.display = "none"; }
        applyFiltersButton.addEventListener('click', () => {
            currentStoreFilter = document.getElementById('storeFilterInput').value;
            currentCategoryFilter = document.getElementById('categoryFilterInput').value;
            currentBrandFilter = document.getElementById('brandFilterInput').value;
            closeFilterModal();
            loadProducts(false);
        });
        clearFiltersButton.addEventListener('click', () => {
            currentQuery = ''; currentStoreFilter = ''; currentCategoryFilter = ''; currentBrandFilter = '';
            searchInput.value = '';
            loadProducts(false);
        });
        searchButton.addEventListener('click', () => { currentQuery = searchInput.value.trim(); loadProducts(false); });
        searchInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') { currentQuery = searchInput.value.trim(); loadProducts(false); } });
        loadMoreBtn.addEventListener('click', () => loadProducts(true));
        
        window.addEventListener('click', (e) => {
            if (e.target === productModal) closeProductModal();
            if (e.target === filterModal) closeFilterModal();
        });

        // Inicialização
        window.onload = function() {
            loadGlobalFilters();
            loadProducts(true);
        };
    </script>
</body>
</html>
