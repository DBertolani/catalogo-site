<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de Afiliados</title>

<style>
    /* Mantive todo o CSS original */
    body {
        font-family: sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f4f4f4;
        color: #333;
        overflow-x: hidden;
    }
    /* ... resto do CSS igual ao seu arquivo ... */
</style>
</head>

<body>

<div class="container">
    <div class="header">
        <h1>Ofertas Incríveis para Você!</h1>
        <p>Encontre os melhores produtos de diversas lojas parceiras.</p>
    </div>

    <div class="search-and-filter-container">
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Buscar por produto, loja...">
            <button id="searchButton">Buscar</button>
        </div>
        <button id="filterButton">Filtros</button>
    </div>

    <div id="activeFilters">
        <p>Filtros aplicados: <span id="filtersAppliedText"></span></p>
        <button id="clearFiltersButton">Limpar</button>
    </div>

    <div id="loader" class="loader"></div>
    <div id="productGrid" class="product-grid"></div>
    <button id="loadMoreBtn" style="display:none;">Carregar Mais Produtos</button>
    <p id="noMoreProducts" style="display:none;">Não há mais produtos para carregar.</p>
</div>

<!-- Mantive os modais originais -->
<div id="productModal" class="modal"> ... </div>
<div id="descriptionModal" class="modal"> ... </div>
<div id="filterModal" class="modal"> ... </div>

<script>
    let currentOffset = 0;
    const productsPerPage = 50;
    let currentQuery = '';
    let totalProductsFound = 0;
    let currentStoreFilter = '';
    let currentCategoryFilter = '';
    let currentBrandFilter = '';

    const productGrid = document.getElementById('productGrid');
    const loader = document.getElementById('loader');
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const noMoreProductsMsg = document.getElementById('noMoreProducts');
    const filtersAppliedText = document.getElementById('filtersAppliedText');
    const activeFiltersContainer = document.getElementById('activeFilters');
    const clearFiltersButton = document.getElementById('clearFiltersButton');

    function showLoader() {
        loader.style.display = 'block';
        productGrid.style.display = 'none';
        loadMoreBtn.style.display = 'none';
        noMoreProductsMsg.style.display = 'none';
    }

    function hideLoader() {
        loader.style.display = 'none';
        productGrid.style.display = 'grid';
    }

    function createProductCard(product) {
        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = `
            <div class="product-card-image-container">
                <img src="${product.imagem}" alt="${product.nome}" class="product-card-image" loading="lazy">
                <div class="product-card-overlay">
                    <h3 class="product-card-title">${product.nome}</h3>
                    <p class="product-card-price">${product.preco}</p>
                </div>
            </div>
            <div class="product-card-content">
                <div class="product-card-buttons">
                    <a href="/p/${product.id}" class="btn-details">Mais Detalhes</a>
                    <a href="${product.linkAfiliado}" target="_blank" class="btn-buy">${product.textoBotao}</a>
                </div>
            </div>
        `;
        return card;
    }

    function updateActiveFiltersDisplay() {
        let filters = [];
        if (currentQuery) filters.push(`Pesquisa: "${currentQuery}"`);
        if (currentStoreFilter) filters.push(`Loja: "${currentStoreFilter}"`);
        if (currentCategoryFilter) filters.push(`Categoria: "${currentCategoryFilter}"`);
        if (currentBrandFilter) filters.push(`Marca: "${currentBrandFilter}"`);

        if (filters.length > 0) {
            filtersAppliedText.innerHTML = filters.map(f => `<span>${f}</span>`).join('');
            activeFiltersContainer.style.display = 'block';
        } else {
            activeFiltersContainer.style.display = 'none';
            filtersAppliedText.textContent = '';
        }
    }

    async function loadProducts(append = true) {
        showLoader();
        if (!append) currentOffset = 0;

        const url = `https://teste-api.deab.com.br/api/produtos?offset=${currentOffset}&limit=${productsPerPage}&query=${encodeURIComponent(currentQuery)}&store=${encodeURIComponent(currentStoreFilter)}&category=${encodeURIComponent(currentCategoryFilter)}&brand=${encodeURIComponent(currentBrandFilter)}`;

        try {
            const res = await fetch(url);
            const response = await res.json();
            hideLoader();

            const products = response.products || [];
            totalProductsFound = response.total || 0;

            if (!append) {
                productGrid.innerHTML = '';
            }

            if (products.length === 0 && currentOffset === 0) {
                productGrid.innerHTML = '<p class="no-products">Nenhum produto encontrado. Tente outra busca ou verifique a planilha.</p>';
                loadMoreBtn.style.display = 'none';
                noMoreProductsMsg.style.display = 'none';
            } else {
                products.forEach(product => {
                    productGrid.appendChild(createProductCard(product));
                });
                currentOffset += products.length;
                if (currentOffset < totalProductsFound) {
                    loadMoreBtn.style.display = 'block';
                    noMoreProductsMsg.style.display = 'none';
                } else {
                    loadMoreBtn.style.display = 'none';
                    noMoreProductsMsg.style.display = 'block';
                }
            }
            updateActiveFiltersDisplay();
        } catch (error) {
            hideLoader();
            console.error("Erro ao carregar produtos:", error);
            productGrid.innerHTML = '<p class="no-products">Ocorreu um erro ao carregar os produtos. Tente novamente mais tarde.</p>';
            loadMoreBtn.style.display = 'none';
            noMoreProductsMsg.style.display = 'none';
            updateActiveFiltersDisplay();
        }
    }

    // Eventos de busca e filtros
    searchButton.addEventListener('click', () => { currentQuery = searchInput.value.trim(); loadProducts(false); });
    searchInput.addEventListener('keypress', e => { if (e.key === 'Enter') { currentQuery = searchInput.value.trim(); loadProducts(false); } });
    loadMoreBtn.addEventListener('click', () => loadProducts(true));
    clearFiltersButton.addEventListener('click', () => { currentQuery = ''; currentStoreFilter = ''; currentCategoryFilter = ''; currentBrandFilter = ''; searchInput.value = ''; loadProducts(false); });

    window.onload = () => loadProducts(true);
</script>

</body>
</html>
