<script>
  let currentOffset = 0;
  const productsPerPage = 50;
  let currentQuery = '';
  let totalProductsFound = 0;
  const MAX_DESC_LENGTH = 250;
  const MAX_TITLE_LENGTH = 50;

  let currentStoreFilter = '';
  let currentCategoryFilter = '';
  let currentBrandFilter = '';

  const productGrid = document.getElementById('productGrid');
  const loader = document.getElementById('loader');
  const searchInput = document.getElementById('searchInput');
  const searchButton = document.getElementById('searchButton');
  const loadMoreBtn = document.getElementById('loadMoreBtn');
  const noMoreProductsMsg = document.getElementById('noMoreProducts');
  const activeFiltersContainer = document.getElementById('activeFilters');
  const filtersAppliedText = document.getElementById('filtersAppliedText');
  const clearFiltersButton = document.getElementById('clearFiltersButton');

  function showLoader() {
    loader.style.display = 'block';
    productGrid.style.display = 'none';
    loadMoreBtn.style.display = 'none';
    noMoreProductsMsg.style.display = 'none';
  }

  function hideLoader() {
    loader.style.display = 'none';
    productGrid.style.display = 'grid';
  }

  function createProductCard(product) {
    const card = document.createElement('div');
    card.className = 'product-card';

    const truncatedTitle = product.nome.length > MAX_TITLE_LENGTH ? product.nome.substring(0, MAX_TITLE_LENGTH) + '...' : product.nome;

    card.innerHTML = `
      <div class="product-card-image-container">
        <img src="${product.imagem}" alt="${product.nome}" class="product-card-image" loading="lazy">
        <div class="product-card-overlay">
          <h3 class="product-card-title">${truncatedTitle}</h3>
          <p class="product-card-price">${product.preco}</p>
        </div>
      </div>
      <div class="product-card-content">
        <div class="product-card-buttons">
          <a href="/p/${product.id}" class="btn-details">Mais Detalhes</a>
          <a href="${product.linkAfiliado}" target="_blank" class="btn-buy">${product.textoBotao}</a>
        </div>
      </div>
    `;
    return card;
  }

  function updateActiveFiltersDisplay() {
    let filters = [];
    if (currentQuery) filters.push(`Pesquisa: "${currentQuery}"`);
    if (currentStoreFilter) filters.push(`Loja: "${currentStoreFilter}"`);
    if (currentCategoryFilter) filters.push(`Categoria: "${currentCategoryFilter}"`);
    if (currentBrandFilter) filters.push(`Marca: "${currentBrandFilter}"`);

    if (filters.length > 0) {
      filtersAppliedText.innerHTML = filters.map(f => `<span>${f}</span>`).join('');
      activeFiltersContainer.style.display = 'block';
    } else {
      activeFiltersContainer.style.display = 'none';
      filtersAppliedText.textContent = '';
    }
  }

  async function loadProducts(append = true) {
    showLoader();
    if (!append) currentOffset = 0;

    const url = `https://teste-api.deab.com.br/api/produtos?offset=${currentOffset}&limit=${productsPerPage}&query=${encodeURIComponent(currentQuery)}&store=${encodeURIComponent(currentStoreFilter)}&category=${encodeURIComponent(currentCategoryFilter)}&brand=${encodeURIComponent(currentBrandFilter)}`;

    try {
      const res = await fetch(url);
      const response = await res.json();
      hideLoader();

      const products = response.products || [];
      totalProductsFound = response.total || 0;

      if (!append) {
        productGrid.innerHTML = '';
      }

      if (products.length === 0 && currentOffset === 0) {
        productGrid.innerHTML = '<p class="no-products">Nenhum produto encontrado. Tente outra busca ou verifique a planilha.</p>';
        loadMoreBtn.style.display = 'none';
        noMoreProductsMsg.style.display = 'none';
      } else {
        products.forEach(product => {
          productGrid.appendChild(createProductCard(product));
        });
        currentOffset += products.length;
        if (currentOffset < totalProductsFound) {
          loadMoreBtn.style.display = 'block';
          noMoreProductsMsg.style.display = 'none';
        } else {
          loadMoreBtn.style.display = 'none';
          noMoreProductsMsg.style.display = 'block';
        }
      }
      updateActiveFiltersDisplay();
    } catch (error) {
      hideLoader();
      console.error("Erro ao carregar produtos:", error);
      productGrid.innerHTML = '<p class="no-products">Ocorreu um erro ao carregar os produtos. Tente novamente mais tarde.</p>';
      loadMoreBtn.style.display = 'none';
      noMoreProductsMsg.style.display = 'none';
      updateActiveFiltersDisplay();
    }
  }

  // Eventos de busca e filtros
  searchButton.addEventListener('click', () => { currentQuery = searchInput.value.trim(); loadProducts(false); });
  searchInput.addEventListener('keypress', e => { if (e.key === 'Enter') { currentQuery = searchInput.value.trim(); loadProducts(false); } });
  loadMoreBtn.addEventListener('click', () => loadProducts(true));
  clearFiltersButton.addEventListener('click', () => { currentQuery = ''; currentStoreFilter = ''; currentCategoryFilter = ''; currentBrandFilter = ''; searchInput.value = ''; loadProducts(false); });

  window.onload = () => loadProducts(true);
</script>
