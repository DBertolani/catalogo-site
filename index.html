<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat√°logo de Ofertas</title>

<style>
    /* RESET GLOBAL */
    * { box-sizing: border-box; }

    body {
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f8f9fa;
        color: #333;
        overflow-x: hidden;
    }

    .no-scroll { overflow: hidden !important; position: fixed; width: 100%; height: 100%; top: 0; left: 0; }

    .container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }

    .header { text-align: center; margin-bottom: 35px; }
    .header h1 { color: #2c3e50; margin-bottom: 10px; }

    /* NOVOS BOT√ïES DE NAVEGA√á√ÉO */
    .nav-shortcuts {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 15px;
    }
    .nav-btn-shortcut {
        text-decoration: none;
        padding: 10px 20px;
        border-radius: 30px;
        font-weight: bold;
        font-size: 0.95em;
        transition: transform 0.2s, box-shadow 0.2s;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .btn-ofertas { background-color: #d32f2f; color: white; border: none; }
    .btn-cupons { background-color: #007bff; color: white; border: none; }
    .nav-btn-shortcut:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); filter: brightness(1.1); }

    /* BARRA DE BUSCA E FILTROS */
    .search-and-filter-container { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; margin-top: 30px; }
    .search-container { flex-grow: 1; display: flex; gap: 10px; }
    .search-container input[type="text"] { flex-grow: 1; padding: 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 16px; transition: border-color 0.3s; }
    .search-container input[type="text"]:focus { border-color: #007bff; outline: none; }
    .search-container button, #filterButton { padding: 12px 20px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background-color 0.2s; }
    .search-container button:hover, #filterButton:hover { background-color: #0056b3; }

    /* GRID DE PRODUTOS */
    .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 25px; justify-content: center; align-items: stretch; }

    .product-card { background-color: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; text-align: center; display: flex; flex-direction: column; position: relative; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid #eee; height: 100%; max-width: 400px; margin: 0 auto; width: 100%; }
    .product-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }

    .product-card-image-container { position: relative; width: 100%; padding-top: 100%; overflow: hidden; background-color: #fff; flex-shrink: 0; }
    .product-card-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; padding: 15px; transition: transform 0.3s ease-in-out; }
    .product-card:hover .product-card-image { transform: scale(1.05); }

    .product-card-content { padding: 15px; display: flex; flex-direction: column; flex-grow: 1; justify-content: space-between; }
    .product-card-title { color: #333; font-size: 1rem; margin: 0 0 10px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; min-height: 4.2em; }
    .product-card-store { font-size: 0.85em; color: #666; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
    .product-card-store span { color: #6f42c1; font-weight: bold; }
    .product-card-price { color: #28a745; font-size: 1.4em; font-weight: 800; margin: 10px 0; }

    .product-card-buttons { display: flex; flex-direction: column; gap: 8px; margin-top: auto; }
    .btn-details { background-color: #6c757d; color: white; padding: 10px; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 0.9em; }
    .btn-details:hover { background-color: #5a6268; }
    .btn-buy { background-color: #28a745; color: white; padding: 12px; border-radius: 6px; text-decoration: none; font-weight: bold; text-transform: uppercase; font-size: 0.9em; display: flex; justify-content: center; align-items: center; gap: 5px; }
    .btn-buy:hover { background-color: #218838; }

    /* LOADER */
    #loader-container { text-align: center; margin: 60px auto; display: none; }
    .loader { border: 5px solid #f3f3f3; border-top: 5px solid #007bff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px auto; }
    .loader-text { font-size: 1.2em; color: #555; font-weight: 500; animation: pulse 1.5s infinite ease-in-out; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

    /* MODAL PRODUTO */
    .modal { display: none; position: fixed; z-index: 1000; inset: 0; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; padding: 15px; backdrop-filter: blur(3px); }
    .modal-content { background-color: #fff; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 900px; max-height: 90vh; display: flex; flex-direction: row; overflow: hidden; position: relative; box-sizing: border-box; }
    
    .modal-image-col { width: 45%; background-color: #fff; display: flex; align-items: center; justify-content: center; padding: 20px; border-right: 1px solid #eee; }
    .modal-image-col img { max-width: 100%; max-height: 50vh; object-fit: contain; }
    .modal-details-col { width: 55%; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }

    .close-button { position: absolute; top: 10px; right: 15px; font-size: 32px; color: #999; cursor: pointer; background: rgba(255,255,255,0.8); border-radius:50%; width:40px; height:40px; display:flex; justify-content:center; align-items:center; border: none; z-index: 100; line-height: 1; }
    .close-button:hover { color: #333; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

    #modalTitle { font-size: 1.6em; margin-top: 0; color: #222; line-height: 1.3; margin-right: 30px; }
    #modalPrice { font-size: 2.2em; font-weight: 800; color: #28a745; margin: 15px 0 5px 0; letter-spacing: -1px; }
    .modal-store-badge { display: inline-block; background-color: #f0f4f8; color: #6f42c1; padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 0.9em; margin-bottom: 20px; border: 1px solid #e1e8ed; }
    .modal-info-row { margin-bottom: 8px; font-size: 0.95em; color: #555; }
    .modal-info-row strong { color: #333; }
    .modal-description-box { background-color: #f9f9f9; padding: 15px; border-radius: 8px; margin: 20px 0; line-height: 1.6; color: #555; font-size: 0.95em; }
    .modal-buttons-container { display: flex; gap: 15px; margin-top: auto; }
    #modalBuyButton, #shareProductButton { flex: 1; text-align: center; padding: 15px; font-size: 1em; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; }
    #shareProductButton { background-color: #6c757d; color: white; }
    #shareProductButton:hover { background-color: #5a6268; }
    #modalBuyButton { background-color: #28a745; color: white; text-transform: uppercase; text-decoration:none; display:flex; justify-content:center; align-items:center;}
    #modalBuyButton:hover { background-color: #218838; }

    /* FILTROS E OUTROS */
    #activeFilters { margin-bottom: 20px; padding: 10px 15px; background-color: #e9ecef; border-radius: 6px; display: none; font-size: 0.9em; }
    #activeFilters p { margin: 0; }
    #clearFiltersButton { margin-left: 10px; padding: 4px 8px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; }
    .no-products { text-align: center; color: #888; margin-top: 50px; font-size: 1.2em; }
    
    /* MODAL DESCRI√á√ÉO E FILTRO */
    #descriptionModal { background-color: rgba(0,0,0,0.8); }
    #descriptionModal .modal-content { max-width: 600px; flex-direction: column; max-height: 80vh; }
    #fullDescriptionText { white-space: pre-wrap; line-height: 1.6; }
    #filterModal .modal-content { max-width: 500px; flex-direction: column; width: 90%; }

    /* RESPONSIVIDADE */
    @media (max-width: 768px) {
        .product-grid { grid-template-columns: repeat(2, 1fr); gap: 15px; } /* 2 Colunas Mobile */
        .product-card { max-width: 100%; margin: 0; }
        .product-card-title { font-size: 0.95em; min-height: 2.8em; height: auto; }
        .product-card-price { font-size: 1.1em; }
        
        /* Modal Mobile */
        .modal-content { flex-direction: column; max-height: 95vh; width: 90%; margin: 0 auto; }
        .modal-image-col { width: 100%; height: 250px; border-right: none; border-bottom: 1px solid #eee; padding: 10px; }
        .modal-image-col img { max-height: 100%; }
        .modal-details-col { width: 100%; padding: 20px; }
        #modalTitle { font-size: 1.3em; margin-right: 0; }
        #modalPrice { font-size: 1.8em; }
        .modal-buttons-container { flex-direction: column; }
    }
</style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Cat√°logo de Produtos</h1>
        <p>Encontre os melhores produtos de diversas lojas parceiras.</p>
        
        <div class="nav-shortcuts">
            <a href="/Ofertas" class="nav-btn-shortcut btn-ofertas">‚ö° Ofertas Rel√¢mpago</a>
            <a href="/Cupons" class="nav-btn-shortcut btn-cupons">üè∑Ô∏è Central de Cupons</a>
        </div>
    </div>

    <div class="search-and-filter-container">
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="O que voc√™ procura hoje?">
            <button id="searchButton">Buscar</button>
        </div>
        <button id="filterButton">Filtros</button>
    </div>
    <div id="activeFilters"><p>Filtros aplicados: <span id="filtersAppliedText"></span> <button id="clearFiltersButton">Limpar</button></p></div>
    <div id="loader-container"><div class="loader"></div><div class="loader-text">Procurando a melhor oferta para voc√™!</div></div>
    <div id="productGrid" class="product-grid"></div>
    <div style="text-align: center; margin: 30px 0;">
        <button id="loadMoreBtn" class="btn-details" style="display:none; width: 200px; margin: 0 auto;">Carregar Mais Produtos</button>
        <p id="noMoreProducts" style="display:none; color: #888;">N√£o h√° mais produtos para carregar.</p>
    </div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <button class="close-button" onclick="closeProductModal()">&times;</button>
            <div class="modal-image-col"><img id="modalImage" src="" alt=""></div>
            <div class="modal-details-col">
                <span class="modal-store-badge" id="modalStoreBadge"></span>
                <h2 id="modalTitle"></h2>
                <div id="modalPrice"></div>
                <div class="modal-info-row"><strong>Marca:</strong> <span id="modalBrand"></span></div>
                <div class="modal-info-row"><strong>Categoria:</strong> <span id="modalCategory"></span></div>
                <div class="modal-description-box">
                    <strong>Detalhes:</strong><br><span id="modalDescription"></span>
                    <a href="javascript:void(0)" id="readMoreLink" style="display: none; color: #007bff; text-decoration: underline;">Ler completa</a>
                </div>
                <div class="modal-buttons-container">
                    <button id="shareProductButton">Compartilhar</button>
                    <a href="#" target="_blank" id="modalBuyButton">Ir para a Loja</a>
                </div>
            </div>
        </div>
    </div>
    <div id="descriptionModal" class="modal"><div class="modal-content" style="padding: 20px;"><button class="close-button" onclick="closeDescriptionModal()">&times;</button><h3>Descri√ß√£o Completa</h3><div id="fullDescriptionText" style="overflow-y: auto; max-height: 60vh;"></div><button class="btn-details" onclick="closeDescriptionModal()" style="margin-top: 20px;">Voltar</button></div></div>
    <div id="filterModal" class="modal"><div class="modal-content" style="max-width: 500px; flex-direction: column;"><button class="close-button" onclick="closeFilterModal()">&times;</button><div style="padding: 20px; width: 100%;"><h3 style="margin-top: 0;">Refinar Busca</h3><div id="filterOptions" style="display: flex; flex-direction: column; gap: 15px;"></div><button id="applyFiltersButton" class="btn-buy" style="margin-top: 20px; width: 100%;">Aplicar Filtros</button></div></div></div>

</div>

<script>
    // ... (Seu Script JS Original do Index.html - Mantenha ele aqui) ...
    // Vou incluir apenas as fun√ß√µes essenciais para garantir que funcione
    
    let currentOffset = 0;
    const productsPerPage = 50;
    let currentQuery = new URLSearchParams(window.location.search).get('query') || '';
    let totalProductsFound = 0;
    const MAX_DESC_LENGTH = 180;
    let currentProduct = null;
    let currentProductDescription = '';
    let currentStoreFilter = '';
    let currentCategoryFilter = '';
    let currentBrandFilter = '';

    const productGrid = document.getElementById('productGrid');
    const loaderContainer = document.getElementById('loader-container');
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const noMoreProductsMsg = document.getElementById('noMoreProducts');
    const activeFiltersContainer = document.getElementById('activeFilters');
    const filtersAppliedText = document.getElementById('filtersAppliedText');
    const clearFiltersButton = document.getElementById('clearFiltersButton');
    const productModal = document.getElementById('productModal');
    const descriptionModal = document.getElementById('descriptionModal');
    const filterModal = document.getElementById('filterModal');
    const modalImage = document.getElementById('modalImage');
    const modalTitle = document.getElementById('modalTitle');
    const modalPrice = document.getElementById('modalPrice');
    const modalStoreBadge = document.getElementById('modalStoreBadge');
    const modalBrand = document.getElementById('modalBrand');
    const modalCategory = document.getElementById('modalCategory');
    const modalDescription = document.getElementById('modalDescription');
    const modalBuyButton = document.getElementById('modalBuyButton');
    const readMoreLink = document.getElementById('readMoreLink');
    const fullDescriptionText = document.getElementById('fullDescriptionText');
    const shareProductButton = document.getElementById('shareProductButton');
    const filterButton = document.getElementById('filterButton');
    const applyFiltersButton = document.getElementById('applyFiltersButton');

    function formatMoney(value) {
        if (!value) return "R$ 0,00";
        let num = typeof value === 'string' ? parseFloat(value.replace('R$', '').replace(',', '.')) : value;
        if (isNaN(num)) return value;
        return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }
    function adjustIframeHeight() { const height = document.body.scrollHeight; if (typeof google !== 'undefined' && google.script && google.script.host) { google.script.host.setHeight(height); } }
    function showLoader() { loaderContainer.style.display = 'block'; productGrid.style.display = 'none'; loadMoreBtn.style.display = 'none'; noMoreProductsMsg.style.display = 'none'; }
    function hideLoader() { loaderContainer.style.display = 'none'; productGrid.style.display = 'grid'; }

    function createProductCard(product) {
        const card = document.createElement('div');
        card.className = 'product-card';
        const priceFormatted = formatMoney(product.preco);
        card.innerHTML = `
            <div class="product-card-image-container"><img src="${product.imagem}" alt="${product.nome}" class="product-card-image" loading="lazy" onerror="this.src='https://via.placeholder.com/300x300?text=Sem+Imagem'"></div>
            <div class="product-card-content">
                <div class="product-card-store">Vendido por <span>${product.lojaParceira || 'Parceiro'}</span></div>
                <h3 class="product-card-title" title="${product.nome}">${product.nome}</h3>
                <div class="product-card-price">${priceFormatted}</div>
                <div class="product-card-buttons">
                    <a href="javascript:void(0)" onclick='openProductModal(${JSON.stringify(product).replace(/'/g, "&apos;")})' class="btn-details">Mais Detalhes</a>
                    <a href="${product.linkAfiliado}" target="_blank" class="btn-buy">Comprar Agora</a>
                </div>
            </div>
        `;
        return card;
    }

    function updateActiveFiltersDisplay() {
        let filters = [];
        if (currentQuery) filters.push(`Pesquisa: "${currentQuery}"`);
        if (currentStoreFilter) filters.push(`Loja: "${currentStoreFilter}"`);
        if (currentCategoryFilter) filters.push(`Categoria: "${currentCategoryFilter}"`);
        if (currentBrandFilter) filters.push(`Marca: "${currentBrandFilter}"`);
        if (filters.length > 0) { filtersAppliedText.innerHTML = filters.map(f => `<strong>${f}</strong>`).join(' | '); activeFiltersContainer.style.display = 'block'; } 
        else { activeFiltersContainer.style.display = 'none'; filtersAppliedText.textContent = ''; }
    }

    async function loadGlobalFilters() {
        const filterApiUrl = "https://teste-api.deab.com.br/api/filtros";
        const container = document.getElementById('filterOptions');
        if (!container) return;
        try {
            const response = await fetch(filterApiUrl);
            const data = await response.json();
            if (!data.stores || !data.categories || !data.brands) return;
            container.innerHTML = `
            <div style="margin-bottom:15px"><label style="font-weight:bold; display:block; margin-bottom:5px;">Loja Parceira:</label><input list="storeDatalist" id="storeFilterInput" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px;" placeholder="Todas as Lojas" value="${currentStoreFilter}"><datalist id="storeDatalist"><option value="">Todas</option>${data.stores.map(s => `<option value="${s}">`).join('')}</datalist></div>
            <div style="margin-bottom:15px"><label style="font-weight:bold; display:block; margin-bottom:5px;">Categoria:</label><input list="categoryDatalist" id="categoryFilterInput" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px;" placeholder="Todas as Categorias" value="${currentCategoryFilter}"><datalist id="categoryDatalist"><option value="">Todas</option>${data.categories.map(c => `<option value="${c}">`).join('')}</datalist></div>
            <div style="margin-bottom:15px"><label style="font-weight:bold; display:block; margin-bottom:5px;">Marca:</label><input list="brandDatalist" id="brandFilterInput" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px;" placeholder="Todas as Marcas" value="${currentBrandFilter}"><datalist id="brandDatalist"><option value="">Todas</option>${data.brands.map(b => `<option value="${b}">`).join('')}</datalist></div>
            `;
        } catch (error) { console.error("Erro ao carregar filtros:", error); }
    }

    function loadProducts(append) {
        append = typeof append === 'undefined' ? true : append;
        showLoader();
        if (!append) currentOffset = 0;
        const url = `https://teste-api.deab.com.br/api/produtos?offset=${currentOffset}&limit=${productsPerPage}&query=${encodeURIComponent(currentQuery)}&store=${encodeURIComponent(currentStoreFilter)}&category=${encodeURIComponent(currentCategoryFilter)}&brand=${encodeURIComponent(currentBrandFilter)}`;
        fetch(url).then(res => res.json()).then(response => {
            hideLoader();
            const products = response.products || [];
            totalProductsFound = response.total || 0;
            if (!append) productGrid.innerHTML = '';
            if (products.length === 0 && currentOffset === 0) { productGrid.innerHTML = '<p class="no-products">Nenhum produto encontrado. Tente outra busca.</p>'; loadMoreBtn.style.display = 'none'; } 
            else { products.forEach(product => { productGrid.appendChild(createProductCard(product)); }); currentOffset += products.length; if (currentOffset < totalProductsFound) { loadMoreBtn.style.display = 'block'; } else { loadMoreBtn.style.display = 'none'; noMoreProductsMsg.style.display = 'block'; } }
            updateActiveFiltersDisplay();
        }).catch(error => { hideLoader(); console.error("Erro:", error); productGrid.innerHTML = '<p class="no-products">Erro de conex√£o.</p>'; });
    }

    function openProductModal(product) {
      if (typeof product === 'string') { try { product = JSON.parse(product); } catch(e){ return; } }
      currentProduct = product;
      currentProductDescription = product.descricao || '';
      modalImage.src = product.imagem || '';
      modalTitle.textContent = product.nome || '';
      modalPrice.textContent = formatMoney(product.preco);
      modalStoreBadge.textContent = product.lojaParceira || 'Parceiro';
      modalBrand.textContent = product.marca || '-';
      modalCategory.textContent = product.categoria || '-';
      modalBuyButton.href = product.linkAfiliado || '#';
      modalBuyButton.textContent = `Comprar na Loja: ${product.lojaParceira}`;
      if ((product.descricao || '').length > MAX_DESC_LENGTH) { modalDescription.textContent = product.descricao.substring(0, MAX_DESC_LENGTH) + '...'; readMoreLink.style.display = 'inline-block'; } 
      else { modalDescription.textContent = product.descricao || 'Sem descri√ß√£o.'; readMoreLink.style.display = 'none'; }
      productModal.style.display = 'flex';
      document.body.classList.add('no-scroll');
    }

    function closeProductModal() { productModal.style.display = 'none'; document.body.classList.remove('no-scroll'); }
    function closeDescriptionModal() { descriptionModal.style.display = 'none'; }
    readMoreLink.addEventListener('click', function() { fullDescriptionText.textContent = currentProductDescription; descriptionModal.style.display = 'flex'; });
    shareProductButton.addEventListener('click', function() { if (!currentProduct) return; const msg = `Olha que oferta!\n\n*${currentProduct.nome}*\nPre√ßo: ${formatMoney(currentProduct.preco)}\nLoja: ${currentProduct.lojaParceira}\n\nLink: ${currentProduct.linkAfiliado}`; window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank'); });
    filterButton.addEventListener('click', () => { filterModal.style.display = "flex"; });
    function closeFilterModal() { filterModal.style.display = "none"; }
    applyFiltersButton.addEventListener('click', () => { currentStoreFilter = document.getElementById('storeFilterInput').value; currentCategoryFilter = document.getElementById('categoryFilterInput').value; currentBrandFilter = document.getElementById('brandFilterInput').value; closeFilterModal(); loadProducts(false); });
    clearFiltersButton.addEventListener('click', () => { currentQuery = ''; currentStoreFilter = ''; currentCategoryFilter = ''; currentBrandFilter = ''; searchInput.value = ''; loadProducts(false); });
    searchButton.addEventListener('click', () => { currentQuery = searchInput.value.trim(); loadProducts(false); });
    searchInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') { currentQuery = searchInput.value.trim(); loadProducts(false); } });
    loadMoreBtn.addEventListener('click', () => loadProducts(true));
    window.addEventListener('click', (e) => { if (e.target === productModal) closeProductModal(); if (e.target === descriptionModal) closeDescriptionModal(); if (e.target === filterModal) closeFilterModal(); });
    window.onload = function() { loadGlobalFilters(); loadProducts(true); };
</script>

</body>
</html>
